#####################################################################################
library(celldex)
library(SingleR)
library(dplyr)
library(Seurat)
library(patchwork)
library(gridExtra)
library(ggplot2)
library(SeuratObject)
library(Seurat)
library(SingleR)
#####################################################################################
# DatabaseImmuneCellExpressionData
# The DICE reference consists of bulk RNA-seq samples of sorted cell populations from the project of the same name (Schmiedel et al. 2018).
# MouseRNAseqData
# This reference consists of a collection of mouse bulk RNA-seq data sets downloaded from the gene expression omnibus (Benayoun et al. 2019). A variety of cell types are available, again mostly from blood but also covering several other tissues.
# ImmGenData
# The ImmGen reference consists of microarray profiles of pure mouse immune cells from the project of the same name (Heng et al. 2008). This is currently the most highly resolved immune reference - possibly overwhelmingly so, given the granularity of the fine labels.
#####################################################################################
load("./hypotha_wnn.RData")
load("./reference.RData")

# Finding differentially expressed features (cluster biomarkers)
hypho=reference
hypho=JoinLayers(hypho, assay = "RNA")

# Calulate predicted annotation
MouseRNAseqData <- MouseRNAseqData()
ImmGenData <- ImmGenData()
DatabaseImmuneCellExpressionData <- celldex::DatabaseImmuneCellExpressionData()

# Annotate celltype
MouseRNAseqData.hypho                                 <- SingleR(test=GetAssayData(hypho, assay = "RNA", slot = "data"), ref=MouseRNAseqData, labels=MouseRNAseqData$label.main)
ImmGenData.hypho                                      <- SingleR(test=GetAssayData(hypho, assay = "RNA", slot = "data"), ref=ImmGenData, labels=ImmGenData$label.main)
DatabaseImmuneCellExpressionData.hypho                <- SingleR(test=GetAssayData(hypho, assay = "RNA", slot = "data"), ref=DatabaseImmuneCellExpressionData, labels=DatabaseImmuneCellExpressionData$label.main)

hypho[["predicted.MouseRNAseqData"]]                  <- MouseRNAseqData.hypho$labels
hypho[["predicted.ImmGenData"]]                       <- ImmGenData.hypho$labels
hypho[["predicted.DatabaseImmuneCellExpressionData"]] <- DatabaseImmuneCellExpressionData.hypho$labels
#####################################################################################
# Copy the UMAP
hypotha_MouseRNAseq                  <- hypotha_wnn
hypotha_ImmGenData                   <- hypotha_wnn
DatabaseImmuneCellExpression         <- hypotha_wnn

# Reset identities
Idents(hypotha_MouseRNAseq)<-MouseRNAseqData.hypho$labels[Idents(hypotha_MouseRNAseq)]
Idents(hypotha_ImmGenData)<-ImmGenData.hypho$labels[Idents(hypotha_ImmGenData)]
Idents(DatabaseImmuneCellExpression)<-DatabaseImmuneCellExpression.hypho$labels[Idents(DatabaseImmuneCellExpression)]

# Calculate plots
plot.hypotha_MouseRNAseq          <- DimPlot(hypho, group.by = c("predicted.MouseRNAseqData"),label=TRUE ) + theme_bw() +ggtitle("MouseRNAseqData")
plot.hypotha_ImmGenData           <- DimPlot(hypho, group.by = c("predicted.ImmGenData"),label=TRUE ) + theme_bw()+ggtitle("ImmGenData")
plot.DatabaseImmuneCellExpression <- DimPlot(hypho, group.by = c("predicted.DatabaseImmuneCellExpressionData"),label=TRUE ) + theme_bw()+ggtitle("DatabaseImmuneCellExpressionData")
plot.hypotha_wnn                  <- DimPlot(hypotha_wnn, group.by = c("idents"),label=TRUE ) + theme_bw()+ggtitle("Reference annotation")

#####################################################################################
# FindClusters_resolution
png(filename=paste(output_dir,"joint_Cluster_annotations.png",sep=""), width = 45, height = 15, res=600, units = "cm")
	grid.arrange(plot.hypotha_wnn,plot.DatabaseImmuneCellExpression,plot.hypotha_ImmGenData, plot.hypotha_MouseRNAseq ,ncol = 3)
dev.off()
