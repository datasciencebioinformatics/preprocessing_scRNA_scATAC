library(dplyr)
library(Seurat)
library(patchwork)
library(gridExtra)
library(ggplot2)
library(plyr)
library(SeuratObject)
library(Seurat)
library("harmony")
library(rhdf5)
library("hdf5r")
library("Signac")
library(Seurat)
options(Seurat.object.assay.version = "v5")
library(Signac)
library(EnsDb.Mmusculus.v79)
library(dplyr)
library(ggplot2)
library(loupeR)
colour=c('Astrocytes' ='#fde725','OPCs' ='#5ec962','Microglia' ='#21918c','Neurons'='#3b528b','Oligodendrocytes'='#440154')
#####################################################################################
# First, create ATAC and RNA objects for all samples 
# follow https://github.com/datasciencebioinformatics/preprocessing_scRNA_scATAC/blob/main/SeuratFullMultiomeObject
# it will creante two main objects ATAC_objects_combined e RNA_objects_combined
#####################################################################################
# ATAC analysis add gene annotation information
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Mmusculus.v79)
seqlevelsStyle(annotations) <- "UCSC"
genome(annotations) <- "mm10"
#####################################################################################
output_dir="/home/felipe/results_seurat/"                                           #
#output_dir="/home/singlecell/results_seurat/"                                      #
#####################################################################################
load("./ATAC_objects_combined.RData")                                               #
load("./RNA_objects_combined.RData")                                                #
#####################################################################################
#- ATAC filters : paper
#	- TSS enrichment greater than 1    : TSS.enrichment
#	- nucleosome signal greater than 2 : nucleosome_signal	
#	- between 1000 and 30000 peaks with >1 readcount detected in each cell : nFeature_ATAC
#	- Common cells among samples       : Rscript
#	- Common cells between RNA+ATAC    : Rscript
#- RNA filters : paper
#	- fraction of mitochondrial genes less than 30% : percent.mt
#	- between 100 and 7500 genes detected in each cell : nFeature_RNA
#	- Common cells among samples	   : Rscript
#	- Common cells between RNA+ATAC    : Rscript
#- Quality control plot Vioilin plot
#	- TSS/nuclueosome/peaks per cell
#	- mitocondial/genes per cell
#####################################################################################
# Create combined multiome object
combined.cell<-Cells(ATAC_objects_combined)[Cells(ATAC_objects_combined) %in% Cells(RNA_objects_combined)]
#####################################################################################
# add the ATAC-seq assay
grange.counts <- StringToGRanges(rownames(ATAC_objects_combined), sep = c(":", "-"))

# Use grange
grange.use <- seqnames(grange.counts) %in% standardChromosomes(grange.counts)

# Combine datasets with same cells
ATAC_objects_combined <- ATAC_objects_combined[,combined.cell]
RNA_objects_combined  <- RNA_objects_combined[,combined.cell]
#####################################################################################
# I stopped here 
# try to do this https://stuartlab.org/signac/articles/hypotha_multiomic
# create a Seurat object containing the RNA adata
hypotha <- RNA_objects_combined

# create ATAC assay and add it to the object
hypotha[["ATAC"]] <- ATAC_objects_combined[["ATAC"]]
#####################################################################################
# Quality control 
DefaultAssay(hypotha) <- "ATAC"

hypotha <- NucleosomeSignal(hypotha)
hypotha <- TSSEnrichment(hypotha,assay ="ATAC", tss.positions =grange.counts)

# FindClusters_resolution
png(filename=paste(output_dir,"plot_VlnPlot_multiome_rna_atac.png",sep=""), width = 24, height = 12, res=600, units = "cm")
	VlnPlot(object = hypotha, features = c("nCount_RNA", "TSS.enrichment", "nucleosome_signal"),ncol = 4,pt.size = 0)
dev.off()
#####################################################################################
save(hypotha, file = "./hypotha.RData")
#####################################################################################
# call peaks using MACS2
peaks <- CallPeaks(hypotha)

# remove peaks on nonstandard chromosomes and in genomic blacklist regions
peaks <- keepStandardChromosomes(peaks, pruning.mode = "coarse")
peaks <- subsetByOverlaps(x = peaks, ranges = blacklist_mm10, invert = TRUE)

#####################################################################################
save(peaks, file = "./peaks.RData")
#####################################################################################
# quantify counts in each peak
macs2_counts <- FeatureMatrix(
  fragments = Fragments(hypotha[["ATAC"]]),
  features = peaks,
  cells = colnames(hypotha)
)
annot=annotations
# create a new assay using the MACS2 peak set and add it to the Seurat object
hypotha[["peaks"]] <- CreateChromatinAssay(
  counts = macs2_counts,
  fragments = Fragments(hypotha[["ATAC"]]),
  annotation = annot
)
#####################################################################################
save(hypotha, file = "./hypotha.RData") # I stopped here
#load("./hypotha.RData") # I stopped here
#####################################################################################
save(hypotha, file = "./hypotha.RData") # I stopped here
#load("./hypotha.RData") # I stopped here
#####################################################################################
# Gene expression data processing 
DefaultAssay(hypotha) <- "RNA"
hypotha <- NormalizeData(hypotha, normalization.method = "LogNormalize", scale.factor = 10000)
hypotha <- SCTransform(hypotha)
hypotha <- RunPCA(hypotha)
#####################################################################################
#save(hypotha, file = "./hypotha.RData") # Save hypotha Step 1
#####################################################################################
#DNA accessibility data processing 
DefaultAssay(hypotha) <- "ATAC"
hypotha <- FindTopFeatures(hypotha, min.cutoff = 10)
hypotha <- RunTFIDF(hypotha)
hypotha <- RunSVD(hypotha)
#####################################################################################
#save(hypotha, file = "./hypotha.RData") # Save hypotha Step 2
#####################################################################################
# Annotating cell types 
# build a joint neighbor graph using both assays
hypotha <- FindMultiModalNeighbors(
  object = hypotha,
  reduction.list = list("pca", "lsi"), 
  dims.list = list(1:20, 2:50),k.nn = 50
)
#####################################################################################
#save(hypotha, file = "./hypotha.RData") # Save hypotha Step 3
#####################################################################################
# build a joint UMAP visualization
hypotha <- RunUMAP(
  object = hypotha, 
  nn.name = "weighted.nn", reduction.name = "wnn.umap", reduction.key = "wnnUMAP_"
)
#####################################################################################
save(hypotha, file = "./hypotha.RData") # Save hypotha Step 4
#####################################################################################
