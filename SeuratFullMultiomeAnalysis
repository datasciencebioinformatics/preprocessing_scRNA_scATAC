#####################################################################################
# First, create ATAC and RNA objects for all samples 
# follow https://github.com/datasciencebioinformatics/preprocessing_scRNA_scATAC/blob/main/SeuratFullMultiomeObject
# it will creante two main objects ATAC_objects_combined e RNA_objects_combined
#####################################################################################
load("./ATAC_objects_combined.RData")                                               #
load("./RNA_objects_combined.RData")                                                #
#####################################################################################
#- ATAC filters : paper
#	- TSS enrichment greater than 1    : TSS.enrichment
#	- nucleosome signal greater than 2 : nucleosome_signal	
#	- between 1000 and 30000 peaks with >1 readcount detected in each cell : nFeature_ATAC
#	- Common cells among samples       : Rscript
#	- Common cells between RNA+ATAC    : Rscript
#- RNA filters : paper
#	- fraction of mitochondrial genes less than 30% : percent.mt
#	- between 100 and 7500 genes detected in each cell : nFeature_RNA
#	- Common cells among samples	   : Rscript
#	- Common cells between RNA+ATAC    : Rscript
#- Quality control plot Vioilin plot
#	- TSS/nuclueosome/peaks per cell
#	- mitocondial/genes per cell
#####################################################################################
# Filter multiome
Multiome_objects_combined <- subset(
  x = ATAC_objects_combined,
  subset = nFeature_ATAC < 30000 &
    nFeature_ATAC > 1000 &
    nFeature_RNA < 7500 &
    nFeature_RNA > 100 &
    nucleosome_signal < 2 &
    TSS.enrichment > 1
)
#####################################################################################
#  Take cell names
ATAC_CellNames<-Cells(ATAC_objects_combined)
RNA_CellNames<-Cells(RNA_objects_combined)

# Com
df_ATAC<-data.frame(Names=ATAC_CellNames,IDs=substring(ATAC_CellNames,1,16),Index=substring(ATAC_CellNames,17,20))
df_RNA<-data.frame(Names=RNA_CellNames,Index=substring(RNA_CellNames,9,24),IDs=substring(RNA_CellNames,1,7))
df_RNA<-data.frame(Names=RNA_CellNames,Index=substring(RNA_CellNames,9,24),IDs=substring(RNA_CellNames,1,7),Indexes= paste(df_RNA$Index,paste(substring(RNA_CellNames,25,26),substring(df_RNA$IDs,7, 8),sep="_"),sep=""))

# Rename cells
ATAC_objects_combined=RenameCells(ATAC_objects_combined, new.names = df_RNA[which(RNA_CellNames %in% df_RNA$Names),"Indexes"])
#####################################################################################







